name: Build QuestSLAM

on: 
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string to use [YEAR]-[MAJOR].[MINOR].[PATCH]-[TYPE] (optional, auto-generated if not provided)'
        required: true
        type: string
      force-build:
        description: Force the APK build
        required: false
        type: boolean
        default: false
      build-type:
        description: 'The type of build. Can be release or dev. Default is dev'
        required: false
        type: choice
        options: [release, dev]
        default: dev 
  workflow_call:
    inputs:
      version:
        description: 'Version string to use [YEAR]-[MAJOR].[MINOR].[PATCH]-[TYPE] (optional, auto-generated if not provided)'
        required: true
        type: string
      force-build:
        description: Force the APK build
        required: false
        type: boolean
        default: false
      make-release:
        description: Make a github release
        required: true
        type: boolean
        default: true
      build-type:
        description: 'The type of build. Can be release or dev. Default is dev'
        required: false
        type: string
        default: dev

jobs:
  determine-publishable-changes:
    runs-on: ubuntu-latest
    outputs:
      csharp-changed: ${{ steps.changes.outputs.csharp }}
      webui-changed: ${{ steps.changes.outputs.web-ui }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get last release tag
        id: get-last-release
        uses: WyriHaximus/github-action-get-previous-tag@v1 
          
      - name: Determine publishable changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            csharp:
              - 'unity/**.cs'
              - 'unity/**.json'
              - 'unity/**.unity'
              - 'unity/**.meta'
            webui:
              - 'questslam-webui/**'
              - 'unity/Assets/StreamingAssets/ui/**'
          base: ${{ steps.get-last-release.outputs.tag }}

  build-webui:
    needs: [determine-publishable-changes]
    name: Build WebUI
    uses: ./.github/workflows/build-webui.yml
    with:
      version: ${{ inputs.version }}
          
  build-apk:
    if: (needs.determine-publishable-changes.outputs.webui-changed == 'true' || needs.determine-publishable-changes.outputs.csharp-changed == 'true') || inputs.force-build
    needs: [determine-publishable-changes, build-webui]
    name: Build the QuestSLAM APK
    uses: ./.github/workflows/build-unity.yml
    with:
      version: ${{ inputs.version }}
      build-type: ${{ inputs.build-type }}
